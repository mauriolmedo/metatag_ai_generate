name: Sync to Drupal.org

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    name: Sync to Drupal.org Git
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Always checkout main branch, not the tag
          fetch-depth: 0  # Full history for tags

      - name: Configure Git
        run: |
          git config --global user.name "elektrorl"
          git config --global user.email "elektrorl@users.noreply.github.com"

      - name: Setup Git credentials
        env:
          DRUPAL_GIT_TOKEN: ${{ secrets.DRUPAL_GIT_TOKEN }}
        run: |
          git config --global credential.helper store
          echo "https://oauth2:${DRUPAL_GIT_TOKEN}@git.drupalcode.org" > ~/.git-credentials

      - name: Add Drupal.org remote
        run: |
          git remote add drupal https://git.drupalcode.org/project/metatag_ai_generate.git || true
          git remote -v

      - name: Push to Drupal.org
        run: |
          # Fetch remote state first
          git fetch drupal || true

          # Push main branch (use --force for initial sync)
          git push drupal main --force

          # Push all tags
          git push drupal --tags --force

      - name: Sync status
        if: success()
        run: |
          echo "âœ… Successfully synced to Drupal.org"
          echo "Branch: main"
          echo "Tags: $(git tag -l | wc -l) tags pushed"
